let suspiciousPaths = dynamic(["AppData", "Temp"]);
let suspiciousExtensions = dynamic([".exe", ".dll"]);

DeviceFileEvents
| where Timestamp > ago(3d)  // reduced time window
| where FolderPath has_any (suspiciousPaths)
| where FileName endswith ".exe" or FileName endswith ".dll"
| join kind=inner (
    DeviceProcessEvents
    | where Timestamp > ago(3d)
    | where ProcessCommandLine has_any (suspiciousPaths)
    | where InitiatingProcessFileName !in~ ("explorer.exe", "svchost.exe", "services.exe")
    | where InitiatingProcessAccountName !endswith "$"
) on DeviceId
| project Timestamp, DeviceName, FileName, FolderPath, ProcessCommandLine, InitiatingProcessFileName, InitiatingProcessAccountName
| limit 500
